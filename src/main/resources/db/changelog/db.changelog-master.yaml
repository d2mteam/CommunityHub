databaseChangeLog:
  - changeSet:
      id: 001-enable-pgcrypto
      author: communityhub
      changes:
        - sql:
            splitStatements: false
            stripComments: true
            sql: create extension if not exists "pgcrypto";

  - changeSet:
      id: 002-create-users
      author: communityhub
      changes:
        - createTable:
            tableName: users
            columns:
              - column:
                  name: id
                  type: uuid
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: username
                  type: varchar(100)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: email
                  type: varchar(255)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: created_at
                  type: timestamptz
                  defaultValueComputed: now()
                  constraints:
                    nullable: false

  - changeSet:
      id: 003-create-groups
      author: communityhub
      changes:
        - createTable:
            tableName: groups
            columns:
              - column:
                  name: id
                  type: bigserial
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: slug
                  type: varchar(150)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: name
                  type: varchar(255)
                  constraints:
                    nullable: false
              - column:
                  name: owner_id
                  type: uuid
                  constraints:
                    nullable: true
              - column:
                  name: created_at
                  type: timestamptz
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: groups
            baseColumnNames: owner_id
            referencedTableName: users
            referencedColumnNames: id

  - changeSet:
      id: 004-create-group-members
      author: communityhub
      changes:
        - createTable:
            tableName: group_members
            columns:
              - column:
                  name: group_id
                  type: bigint
                  constraints:
                    nullable: false
              - column:
                  name: user_id
                  type: uuid
                  constraints:
                    nullable: false
              - column:
                  name: role
                  type: varchar(30)
                  defaultValue: MEMBER
                  constraints:
                    nullable: false
              - column:
                  name: state
                  type: varchar(30)
                  defaultValue: ACTIVE
                  constraints:
                    nullable: false
              - column:
                  name: joined_at
                  type: timestamptz
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addPrimaryKey:
            tableName: group_members
            columnNames: group_id, user_id
        - addForeignKeyConstraint:
            baseTableName: group_members
            baseColumnNames: group_id
            referencedTableName: groups
            referencedColumnNames: id
        - addForeignKeyConstraint:
            baseTableName: group_members
            baseColumnNames: user_id
            referencedTableName: users
            referencedColumnNames: id
        - createIndex:
            tableName: group_members
            indexName: idx_group_members_user_group
            columns:
              - column:
                  name: user_id
              - column:
                  name: group_id

  - changeSet:
      id: 005-create-posts
      author: communityhub
      changes:
        - createTable:
            tableName: posts
            columns:
              - column:
                  name: id
                  type: bigserial
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: group_id
                  type: bigint
                  constraints:
                    nullable: false
              - column:
                  name: author_id
                  type: uuid
                  constraints:
                    nullable: false
              - column:
                  name: title
                  type: varchar(255)
                  constraints:
                    nullable: false
              - column:
                  name: body
                  type: text
                  constraints:
                    nullable: false
              - column:
                  name: status
                  type: varchar(30)
                  defaultValue: ACTIVE
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: timestamptz
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: timestamptz
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: posts
            baseColumnNames: group_id
            referencedTableName: groups
            referencedColumnNames: id
        - addForeignKeyConstraint:
            baseTableName: posts
            baseColumnNames: author_id
            referencedTableName: users
            referencedColumnNames: id
        - createIndex:
            tableName: posts
            indexName: idx_posts_group_created
            columns:
              - column:
                  name: group_id
              - column:
                  name: created_at
                  descending: true
              - column:
                  name: id
                  descending: true
        - createIndex:
            tableName: posts
            indexName: idx_posts_author_created
            columns:
              - column:
                  name: author_id
              - column:
                  name: created_at
                  descending: true
              - column:
                  name: id
                  descending: true

  - changeSet:
      id: 006-create-comments
      author: communityhub
      changes:
        - createTable:
            tableName: comments
            columns:
              - column:
                  name: id
                  type: bigserial
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: post_id
                  type: bigint
                  constraints:
                    nullable: false
              - column:
                  name: author_id
                  type: uuid
                  constraints:
                    nullable: false
              - column:
                  name: parent_id
                  type: bigint
              - column:
                  name: body
                  type: text
                  constraints:
                    nullable: false
              - column:
                  name: status
                  type: varchar(30)
                  defaultValue: ACTIVE
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: timestamptz
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: timestamptz
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: comments
            baseColumnNames: post_id
            referencedTableName: posts
            referencedColumnNames: id
        - addForeignKeyConstraint:
            baseTableName: comments
            baseColumnNames: author_id
            referencedTableName: users
            referencedColumnNames: id
        - addForeignKeyConstraint:
            baseTableName: comments
            baseColumnNames: parent_id
            referencedTableName: comments
            referencedColumnNames: id
        - createIndex:
            tableName: comments
            indexName: idx_comments_post_created
            columns:
              - column:
                  name: post_id
              - column:
                  name: created_at
              - column:
                  name: id
        - createIndex:
            tableName: comments
            indexName: idx_comments_parent_created
            columns:
              - column:
                  name: parent_id
              - column:
                  name: created_at
              - column:
                  name: id

  - changeSet:
      id: 007-create-notifications
      author: communityhub
      changes:
        - createTable:
            tableName: notif_events
            columns:
              - column:
                  name: id
                  type: bigserial
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: type
                  type: varchar(50)
                  constraints:
                    nullable: false
              - column:
                  name: actor_id
                  type: uuid
              - column:
                  name: target_user_id
                  type: uuid
              - column:
                  name: entity_type
                  type: varchar(30)
                  constraints:
                    nullable: false
              - column:
                  name: entity_id
                  type: bigint
                  constraints:
                    nullable: false
              - column:
                  name: payload
                  type: jsonb
              - column:
                  name: created_at
                  type: timestamptz
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: notif_events
            baseColumnNames: actor_id
            referencedTableName: users
            referencedColumnNames: id
        - addForeignKeyConstraint:
            baseTableName: notif_events
            baseColumnNames: target_user_id
            referencedTableName: users
            referencedColumnNames: id
        - createIndex:
            tableName: notif_events
            indexName: idx_notif_events_target_created
            columns:
              - column:
                  name: target_user_id
              - column:
                  name: created_at
                  descending: true
              - column:
                  name: id
                  descending: true

  - changeSet:
      id: 008-create-notif-inbox
      author: communityhub
      changes:
        - createTable:
            tableName: notif_inbox
            columns:
              - column:
                  name: user_id
                  type: uuid
                  constraints:
                    nullable: false
              - column:
                  name: event_id
                  type: bigint
                  constraints:
                    nullable: false
              - column:
                  name: read_at
                  type: timestamptz
        - addPrimaryKey:
            tableName: notif_inbox
            columnNames: user_id, event_id
        - addForeignKeyConstraint:
            baseTableName: notif_inbox
            baseColumnNames: user_id
            referencedTableName: users
            referencedColumnNames: id
        - addForeignKeyConstraint:
            baseTableName: notif_inbox
            baseColumnNames: event_id
            referencedTableName: notif_events
            referencedColumnNames: id
        - createIndex:
            tableName: notif_inbox
            indexName: idx_notif_inbox_user_read
            columns:
              - column:
                  name: user_id
              - column:
                  name: read_at
              - column:
                  name: event_id
                  descending: true
